(function(){function e(){l.canvas.height=window.innerHeight,l.canvas.width=window.innerWidth,l.strokeStyle="gray",l.textBaseline="middle",f=Math.min(l.canvas.height/20,l.canvas.width/17),f=Math.floor(f),l.font=.75*f+"px monospace"}function c(e,c,r){c=c||0;for(var i=0;i<e.length-c;i+=1)for(var n=c;n<e[i].length-c;n+=1)(r||e[i][n])&&(l.fillStyle=v[e[i][n]],t=n-c,a=i,l.beginPath(),l.rect(t*f,a*f,f,f),l.fill(),l.stroke());var t,a}function r(){if(h.board){if(l.clearRect(0,0,l.canvas.width,l.canvas.height),l.save(),h.pause&&(l.globalAlpha=.5),c(h.board,2,!0),l.save(),l.translate((h.pieceX-2)*f,h.pieceY*f),c(h.currentPiece),l.restore(),l.save(),l.translate(12*f,2*f),c(h.nextPiece,0,!0),l.restore(),!h.pause){for(var e=0;!n(h.currentPiece,h.pieceX,h.pieceY+e+1);)e+=1;e&&(l.save(),l.globalAlpha*=.5,l.translate((h.pieceX-2)*f,(h.pieceY+e)*f),c(h.currentPiece),l.restore())}l.save(),l.translate(12*f,(18-h.switchPiece.length)*f),c(h.switchPiece,0,!0),l.restore(),l.restore(),l.fillStyle=h.pause&&!h.over?"#666":"#000",l.fillText("Lines: "+h.lines,12*f,10*f),h.over&&(l.save(),l.strokeStyle="#F00",l.lineWidth=2,l.font="bold "+3*f+"px monospace",l.textAlign="center",l.fillText("GAME",5*f,7.5*f),l.strokeText("GAME",5*f,7.5*f),l.fillText("OVER",5*f,13*f),l.strokeText("OVER",5*f,13*f),l.restore())}}function i(){h.counter=0;var e=n(h.currentPiece,h.pieceX,h.pieceY+1);if(e){for(var c=0;c<h.currentPiece.length;c+=1)for(var i=0;i<h.currentPiece[c].length;i+=1)h.currentPiece[c][i]&&(h.board[c+h.pieceY][i+h.pieceX]=h.currentPiece[c][i]);!function(e,c){for(var r=Math.min(e+c,h.board.length-2),i=!1,n=e;n<r;n+=1){for(var t=!0,a=2;a<12&&t;a+=1)t=h.board[n][a]>0&&h.board[n][a]<8;if(t)if(i)u();else{for(var a=n;a>0;a-=1)h.board[a]=Array.apply(void 0,h.board[a-1]);h.board[0]=[8,8,0,0,0,0,0,0,0,0,0,0,8,8],h.lines+=1,i=!0}}i&&(h.speed*=.95)}(h.pieceY,h.currentPiece.length),a(),n(h.currentPiece,h.pieceX,h.pieceY)&&u()}else h.pieceY+=1;return r(),e}function n(e,c,r){for(var i=!1,n=0;n<e.length;n+=1)for(var t=0;t<e[n].length;t+=1)i=i||e[n][t]&&h.board[n+r][t+c];return i}function t(){if(!h.nextPieces.length)for(var e=function(e){for(var c,r,i=e.length;0!==i;)r=Math.floor(Math.random()*i),c=e[i-=1],e[i]=e[r],e[r]=c;return e}([0,1,2,3,4,5,6]),c=0;c<e.length;c+=1)h.nextPieces[c]=P[e[c]];return h.nextPieces.pop()}function a(){h.pieceX=5,h.pieceY=0,h.canSwitch=!0,h.currentPiece=h.nextPiece,h.nextPiece=t()}function o(){h.pause||(h.counter<h.speed?h.counter+=1:i())}function s(){window.onkeydown=function(e){var c;switch(e.keyCode||e.which||0){case 13:h.over&&p();break;case 16:h.pause||function(){if(h.canSwitch&&!n(h.switchPiece,5,2)){h.canSwitch=!1,h.pieceX=5,h.pieceY=0;var e=h.currentPiece;h.currentPiece=h.switchPiece,h.switchPiece=e,r()}}();break;case 32:h.pause||function(){for(;!i(););}();break;case 37:case 65:h.pause||n(h.currentPiece,h.pieceX-1,h.pieceY)||(h.pieceX-=1,r());break;case 38:case 87:h.pause||(n(c=function(e){for(var c=[],r=0;r<e.length;r+=1){c[r]=[];for(var i=0;i<e[r].length;i+=1)c[r][i]=e[r][e[r].length-i-1]}return c}(function(e){for(var c=[],r=0;r<e[0].length;r+=1){for(var i=[],n=0;n<e.length;n+=1)i.push(e[n][r]);c[r]=i}return c}(h.currentPiece)),h.pieceX,h.pieceY)?n(c,h.pieceX,h.pieceY+1)?n(c,h.pieceX+1,h.pieceY)?n(c,h.pieceX-1,h.pieceY)?n(c,h.pieceX+1,h.pieceY+1)?n(c,h.pieceX-1,h.pieceY+1)||(h.currentPiece=c,h.pieceX-=1,h.pieceY+=1,r()):(h.currentPiece=c,h.pieceX+=1,h.pieceY+=1,r()):(h.currentPiece=c,h.pieceX-=1,r()):(h.currentPiece=c,h.pieceX+=1,r()):(h.currentPiece=c,h.pieceY+=1,r()):(h.currentPiece=c,r()));break;case 39:case 68:h.pause||n(h.currentPiece,h.pieceX+1,h.pieceY)||(h.pieceX+=1,r());break;case 40:case 83:h.pause||i();break;case 80:h.over||(h.pause=!h.pause,r());break;case 81:h.pause&&u()}},window.onresize=function(){e(),r()}}function u(){h.over=!0,h.pause=!0,r()}function p(){h.board=[[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,0,0,0,0,0,0,0,0,0,0,8,8],[8,8,8,8,8,8,8,8,8,8,8,8,8,8],[8,8,8,8,8,8,8,8,8,8,8,8,8,8]],h.nextPieces=[],h.nextPiece=t(),h.switchPiece=t(),a(),h.lines=0,h.speed=75,h.counter=0,h.pause=!1,h.over=!1,r()}var l=document.getElementsByTagName("canvas")[0].getContext("2d"),f=0,h={counter:0,board:null,currentPiece:null,pieceX:0,pieceY:5,nextPiece:null,switchPiece:null,nextPieces:null,canSwitch:!1,pause:!1,over:!1,lines:0,speed:0};const v=["#111","#F00","#00F","#0F0","#0FF","#F0F","#FF0","orangered","#CCC"],P=[[[0,0,0,0],[4,4,4,4],[0,0,0,0],[0,0,0,0]],[[2,0,0],[2,2,2],[0,0,0]],[[0,0,7],[7,7,7],[0,0,0]],[[0,0,0,0],[0,6,6,0],[0,6,6,0],[0,0,0,0]],[[0,3,3],[3,3,0],[0,0,0]],[[0,5,0],[5,5,5],[0,0,0]],[[1,1,0],[0,1,1],[0,0,0]]];e(),p(),s(),setInterval(o,20)}).call();
